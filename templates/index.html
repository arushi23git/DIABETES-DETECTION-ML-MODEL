<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diabetes Detection & Assessment</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            animation: fadeIn 0.8s ease-in;
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.95;
            margin-bottom: 5px;
        }

        .header .subtitle {
            font-size: 1em;
            opacity: 0.85;
            font-style: italic;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.8s ease-out;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.5em;
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-icon {
            font-size: 1.3em;
        }

        .form-section {
            margin-bottom: 35px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .form-group {
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: #333;
            font-weight: 600;
            font-size: 0.95em;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: #f8f9fa;
            cursor: pointer;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .checkbox-item:hover {
            background: #e8e9fa;
            border-color: #667eea;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-container {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 18px 30px;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-predict {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-predict:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
        }

        .btn-predict:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-reset {
            background: #f0f0f0;
            color: #333;
        }

        .btn-reset:hover {
            background: #e0e0e0;
            transform: translateY(-3px);
        }

        .results-container {
            display: none;
            gap: 20px;
            margin-top: 30px;
        }

        .results-container.show {
            display: grid;
            grid-template-columns: 1fr 1fr;
            animation: fadeIn 0.5s ease-in;
        }

        .result-card {
            padding: 25px;
            border-radius: 15px;
            color: white;
        }

        .result-card.risk {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .result-card.status {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .result-card.low-risk {
            background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
        }

        .result-card.high-risk {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        }

        .result-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .result-icon {
            font-size: 1.5em;
        }

        .result-status {
            font-size: 1.8em;
            font-weight: bold;
            margin: 15px 0;
        }

        .probability-bar {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            height: 12px;
            margin: 15px 0;
            overflow: hidden;
        }

        .probability-fill {
            height: 100%;
            background: white;
            border-radius: 10px;
            transition: width 1s ease-out;
        }

        .probability-text {
            font-size: 0.95em;
            margin-top: 8px;
            opacity: 0.9;
        }

        .recommendation {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            font-size: 0.95em;
            line-height: 1.6;
        }

        .loading {
            display: none;
            text-align: center;
            margin-top: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid rgba(102, 126, 234, 0.3);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .error.show {
            display: block;
            animation: shake 0.5s ease-in-out;
        }

        .info-box {
            background: #e7f5ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info-box p {
            color: #333;
            line-height: 1.6;
            margin: 5px 0;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .footer {
            text-align: center;
            color: white;
            margin-top: 30px;
            opacity: 0.9;
            font-size: 0.95em;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }

            .card {
                padding: 25px;
            }

            .form-grid,
            .checkbox-grid {
                grid-template-columns: 1fr;
            }

            .btn-container {
                flex-direction: column;
            }

            .results-container.show {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• Diabetes Detection & Assessment</h1>
            <p>AI-Powered Risk Assessment & Real-Time Status Check</p>
            <p class="subtitle">Answer questions about your lifestyle, symptoms, and current condition</p>
        </div>

        <div class="card">
            <div class="info-box">
                <p><strong>üìã How it works:</strong></p>
                <p>‚Ä¢ Answer questions about your lifestyle and medical history for <strong>long-term diabetes risk</strong></p>
                <p>‚Ä¢ Tell us your current symptoms to assess your <strong>blood sugar status right now</strong></p>
                <p>‚Ä¢ Get instant AI-powered analysis with personalized recommendations</p>
            </div>

            <form id="diabetesForm">
                <!-- Test Information -->
                <div class="form-section">
                    <div class="section-title">
                        <span class="section-icon">üìã</span>
                        Test Information
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="patient_name">Full Name *</label>
                            <input type="text" id="patient_name" name="patient_name"
                                   placeholder="Enter your full name" required>
                        </div>

                        <div class="form-group">
                            <label for="patient_email">Email Address (Optional)</label>
                            <input type="email" id="patient_email" name="patient_email"
                                   placeholder="your.email@example.com">
                        </div>

                        <div class="form-group">
                            <label for="patient_phone">Phone Number (Optional)</label>
                            <input type="tel" id="patient_phone" name="patient_phone"
                                   placeholder="+1 234 567 8900">
                        </div>

                        <div class="form-group">
                            <label for="test_date">Test Date & Time *</label>
                            <input type="datetime-local" id="test_date" name="test_date" required>
                        </div>
                    </div>
                </div>

                <!-- Personal Information -->
                <div class="form-section">
                    <div class="section-title">
                        <span class="section-icon">üë§</span>
                        Personal Information
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="age">Age (years)</label>
                            <input type="number" id="age" name="age" min="1" max="120" required>
                        </div>

                        <div class="form-group">
                            <label for="gender">Gender</label>
                            <select id="gender" name="gender" required>
                                <option value="">Select Gender</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="bmi_category">Body Mass Index (BMI) Category</label>
                            <select id="bmi_category" name="bmi_category" required>
                                <option value="">Select BMI Category</option>
                                <option value="0">Underweight (BMI &lt; 18.5)</option>
                                <option value="1">Normal (BMI 18.5-24.9)</option>
                                <option value="2">Overweight (BMI 25-29.9)</option>
                                <option value="3">Obese (BMI ‚â• 30)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Lifestyle & Medical History -->
                <div class="form-section">
                    <div class="section-title">
                        <span class="section-icon">üèÉ</span>
                        Lifestyle & Medical History
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="family_history">Family History of Diabetes</label>
                            <select id="family_history" name="family_history" required>
                                <option value="">Select Option</option>
                                <option value="0">No family history</option>
                                <option value="1">Yes (parent, sibling, or close relative)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="physical_activity">Physical Activity Level</label>
                            <select id="physical_activity" name="physical_activity" required>
                                <option value="">Select Activity Level</option>
                                <option value="0">None (sedentary lifestyle)</option>
                                <option value="1">Light (1-2 days/week)</option>
                                <option value="2">Moderate (3-4 days/week)</option>
                                <option value="3">High (5+ days/week)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="diet_quality">Diet Quality</label>
                            <select id="diet_quality" name="diet_quality" required>
                                <option value="">Select Diet Quality</option>
                                <option value="0">Poor (high sugar, processed foods)</option>
                                <option value="1">Average (mixed diet)</option>
                                <option value="2">Good (balanced, healthy diet)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Common Symptoms -->
                <div class="form-section">
                    <div class="section-title">
                        <span class="section-icon">ü©∫</span>
                        Common Diabetes Symptoms (Check all that apply)
                    </div>
                    <div class="checkbox-grid">
                        <div class="checkbox-item">
                            <input type="checkbox" id="frequent_urination" name="frequent_urination" value="1">
                            <label for="frequent_urination">Frequent urination</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="excessive_thirst" name="excessive_thirst" value="1">
                            <label for="excessive_thirst">Excessive thirst</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="unexplained_weight" name="unexplained_weight" value="1">
                            <label for="unexplained_weight">Unexplained weight loss</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="fatigue" name="fatigue" value="1">
                            <label for="fatigue">Constant fatigue</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="blurred_vision" name="blurred_vision" value="1">
                            <label for="blurred_vision">Blurred vision</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="slow_healing" name="slow_healing" value="1">
                            <label for="slow_healing">Slow healing wounds</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="tingling_hands" name="tingling_hands" value="1">
                            <label for="tingling_hands">Tingling in hands/feet</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="frequent_infections" name="frequent_infections" value="1">
                            <label for="frequent_infections">Frequent infections</label>
                        </div>
                    </div>
                </div>

                <!-- Current Status -->
                <div class="form-section">
                    <div class="section-title">
                        <span class="section-icon">‚è∞</span>
                        Current Status (Right Now)
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="recent_meal">When did you last eat?</label>
                            <select id="recent_meal" name="recent_meal" required>
                                <option value="">Select Option</option>
                                <option value="0">Fasting (8+ hours ago)</option>
                                <option value="1">Recently (within 2 hours)</option>
                                <option value="2">More than 2 hours ago</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="meal_type">Type of last meal</label>
                            <select id="meal_type" name="meal_type" required>
                                <option value="">Select Meal Type</option>
                                <option value="0">Light (snack, fruit)</option>
                                <option value="1">Normal (balanced meal)</option>
                                <option value="2">Heavy (large/sugary meal)</option>
                            </select>
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <label style="font-weight: 600; color: #333; margin-bottom: 15px; display: block;">
                            Current Symptoms (Check what you're feeling RIGHT NOW)
                        </label>
                        <div class="checkbox-grid">
                            <div class="checkbox-item">
                                <input type="checkbox" id="feeling_shaky" name="feeling_shaky" value="1">
                                <label for="feeling_shaky">Feeling shaky/weak</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="excessive_hunger" name="excessive_hunger" value="1">
                                <label for="excessive_hunger">Extremely hungry</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="sweating" name="sweating" value="1">
                                <label for="sweating">Unusual sweating</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="confusion" name="confusion" value="1">
                                <label for="confusion">Confusion/dizziness</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="rapid_heartbeat" name="rapid_heartbeat" value="1">
                                <label for="rapid_heartbeat">Rapid heartbeat</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="btn-container">
                    <button type="submit" class="btn btn-predict">
                        üîç Analyze My Health Status
                    </button>
                    <button type="button" class="btn btn-reset" onclick="resetForm()">
                        üîÑ Reset Form
                    </button>
                </div>
            </form>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p style="margin-top: 15px; color: #667eea; font-weight: 600;">
                    AI is analyzing your health data...
                </p>
            </div>

            <div class="error" id="error"></div>

            <div class="results-container" id="results">
                <!-- Export Button -->
                <div style="grid-column: 1 / -1; margin-bottom: 20px;">
                    <button class="btn btn-export" onclick="exportReport()" style="width: 100%; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span style="font-size: 1.3em;">üìÑ</span>
                        <span>Export Report as PDF</span>
                    </button>
                </div>

                <!-- Long-term Risk Card -->
                <div class="result-card risk" id="riskCard">
                    <div class="result-title">
                        <span class="result-icon">üìä</span>
                        Long-term Diabetes Risk
                    </div>
                    <div class="result-status" id="riskStatus"></div>
                    <div class="probability-bar">
                        <div class="probability-fill" id="riskBar"></div>
                    </div>
                    <div class="probability-text" id="riskProb"></div>
                    <div class="recommendation" id="riskRec"></div>
                </div>

                <!-- Current Status Card -->
                <div class="result-card status" id="statusCard">
                    <div class="result-title">
                        <span class="result-icon">‚ö°</span>
                        Current Blood Sugar Status
                    </div>
                    <div class="result-status" id="statusStatus"></div>
                    <div class="probability-bar">
                        <div class="probability-fill" id="statusBar"></div>
                    </div>
                    <div class="probability-text" id="statusProb"></div>
                    <div class="recommendation" id="statusRec"></div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>‚öïÔ∏è <strong>Important:</strong> This is an AI screening tool, not a medical diagnosis.</p>
            <p>Please consult with healthcare professionals for proper medical advice and testing.</p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        const form = document.getElementById('diabetesForm');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const error = document.getElementById('error');

        // Global variables - stored directly on window object
        window.currentTestData = null;
        window.testCompleted = false;

        // Set current date and time on page load
        window.addEventListener('DOMContentLoaded', () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');

            const dateTimeStr = `${year}-${month}-${day}T${hours}:${minutes}`;
            document.getElementById('test_date').value = dateTimeStr;

            console.log('üöÄ Page loaded - testCompleted:', window.testCompleted);
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Hide previous results
            results.classList.remove('show');
            error.classList.remove('show');
            loading.classList.add('show');

            // Disable submit button
            const submitBtn = form.querySelector('.btn-predict');
            submitBtn.disabled = true;

            // Collect form data
            const formData = {
                // Test information
                patient_name: document.getElementById('patient_name').value,
                patient_email: document.getElementById('patient_email').value,
                patient_phone: document.getElementById('patient_phone').value,
                test_date: document.getElementById('test_date').value,
                gender: document.getElementById('gender').value,

                // Health data
                age: document.getElementById('age').value,
                bmi_category: document.getElementById('bmi_category').value,
                family_history: document.getElementById('family_history').value,
                physical_activity: document.getElementById('physical_activity').value,
                diet_quality: document.getElementById('diet_quality').value,
                frequent_urination: document.getElementById('frequent_urination').checked ? 1 : 0,
                excessive_thirst: document.getElementById('excessive_thirst').checked ? 1 : 0,
                unexplained_weight: document.getElementById('unexplained_weight').checked ? 1 : 0,
                fatigue: document.getElementById('fatigue').checked ? 1 : 0,
                blurred_vision: document.getElementById('blurred_vision').checked ? 1 : 0,
                slow_healing: document.getElementById('slow_healing').checked ? 1 : 0,
                tingling_hands: document.getElementById('tingling_hands').checked ? 1 : 0,
                frequent_infections: document.getElementById('frequent_infections').checked ? 1 : 0,
                recent_meal: document.getElementById('recent_meal').value,
                meal_type: document.getElementById('meal_type').value,
                feeling_shaky: document.getElementById('feeling_shaky').checked ? 1 : 0,
                excessive_hunger: document.getElementById('excessive_hunger').checked ? 1 : 0,
                sweating: document.getElementById('sweating').checked ? 1 : 0,
                confusion: document.getElementById('confusion').checked ? 1 : 0,
                rapid_heartbeat: document.getElementById('rapid_heartbeat').checked ? 1 : 0
            };

            try {
                const response = await fetch('http://localhost:5000/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    throw new Error('Prediction failed');
                }

                const data = await response.json();
                displayResults(data);

            } catch (err) {
                error.textContent = '‚ùå Error: Unable to connect to the server. Make sure the Flask backend is running on port 5000.';
                error.classList.add('show');
            } finally {
                loading.classList.remove('show');
                submitBtn.disabled = false;
            }
        });

        function displayResults(data) {
            const riskCard = document.getElementById('riskCard');
            const statusCard = document.getElementById('statusCard');

            // Display Long-term Risk
            const riskPrediction = data.diabetes_risk.prediction;
            const riskProb = data.diabetes_risk.probability.high_risk;

            document.getElementById('riskStatus').textContent =
                riskPrediction === 1 ? 'HIGH RISK ‚ö†Ô∏è' : 'LOW RISK ‚úÖ';
            document.getElementById('riskBar').style.width = riskProb + '%';
            document.getElementById('riskProb').textContent =
                `Risk Level: ${riskProb.toFixed(1)}%`;

            if (riskPrediction === 1) {
                riskCard.classList.remove('low-risk');
                riskCard.classList.add('high-risk');
                document.getElementById('riskRec').innerHTML =
                    '<strong>‚ö†Ô∏è Recommendation:</strong> Your lifestyle and symptoms indicate elevated diabetes risk. ' +
                    'Please consult with a healthcare provider for proper screening (HbA1c test, fasting glucose). ' +
                    'Consider lifestyle modifications: increase physical activity, improve diet, maintain healthy weight.';
            } else {
                riskCard.classList.remove('high-risk');
                riskCard.classList.add('low-risk');
                document.getElementById('riskRec').innerHTML =
                    '<strong>‚úÖ Good News:</strong> Your current risk factors are low. ' +
                    'Maintain your healthy lifestyle with regular exercise, balanced diet, and routine check-ups.';
            }

            // Display Current Status
            const statusPrediction = data.current_status.prediction;
            const statusProb = data.current_status.probability.concerning;

            document.getElementById('statusStatus').textContent =
                statusPrediction === 1 ? 'CONCERNING ‚ö†Ô∏è' : 'NORMAL ‚úÖ';
            document.getElementById('statusBar').style.width = statusProb + '%';
            document.getElementById('statusProb').textContent =
                `Alert Level: ${statusProb.toFixed(1)}%`;

            if (statusPrediction === 1) {
                statusCard.classList.remove('low-risk');
                statusCard.classList.add('high-risk');
                document.getElementById('statusRec').innerHTML =
                    '<strong>‚ö†Ô∏è Immediate Action:</strong> Your current symptoms suggest possible blood sugar issues. ' +
                    'If you have diabetes, check your glucose levels now. If symptoms worsen (severe confusion, loss of consciousness), ' +
                    'seek immediate medical attention. Consider having a small snack if hypoglycemic.';
            } else {
                statusCard.classList.remove('high-risk');
                statusCard.classList.add('low-risk');
                document.getElementById('statusRec').innerHTML =
                    '<strong>‚úÖ Status Normal:</strong> Your current symptoms don\'t indicate immediate blood sugar concerns. ' +
                    'Continue monitoring your health and maintain regular meal patterns.';
            }

            // Show results with animation
            results.classList.add('show');

            // Scroll to results
            setTimeout(() => {
                results.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        }

        function resetForm() {
            form.reset();
            results.classList.remove('show');
            error.classList.remove('show');
            window.currentTestData = null;
            window.testCompleted = false;

            console.log('üîÑ Form reset - testCompleted set to:', window.testCompleted);

            // Reset date time to current
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('test_date').value = `${year}-${month}-${day}T${hours}:${minutes}`;

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function exportReport() {
            console.log('='.repeat(50));
            console.log('üñ±Ô∏è EXPORT BUTTON CLICKED');

            // Check if results are visible (most reliable check)
            const resultsDiv = document.getElementById('results');
            const resultsVisible = resultsDiv && resultsDiv.classList.contains('show');

            console.log('Results div visible:', resultsVisible);
            console.log('testCompleted flag:', window.testCompleted);
            console.log('currentTestData exists:', window.currentTestData !== null);
            console.log('='.repeat(50));

            // Use visibility check as primary method
            if (!resultsVisible) {
                console.error('‚ùå Results not visible yet');
                alert('Please complete the test first before exporting!');
                return;
            }

            // If results are visible but data is missing, collect from form
            if (!window.currentTestData) {
                console.log('‚ö†Ô∏è Data missing, collecting from form...');

                // Collect form data
                const formData = {
                    patient_name: document.getElementById('patient_name').value,
                    patient_email: document.getElementById('patient_email').value,
                    patient_phone: document.getElementById('patient_phone').value,
                    test_date: document.getElementById('test_date').value,
                    gender: document.getElementById('gender').value,
                    age: document.getElementById('age').value,
                    bmi_category: document.getElementById('bmi_category').value,
                    family_history: document.getElementById('family_history').value,
                    physical_activity: document.getElementById('physical_activity').value,
                    diet_quality: document.getElementById('diet_quality').value
                };

                // Collect results from displayed cards
                const riskStatus = document.getElementById('riskStatus').textContent;
                const riskProb = document.getElementById('riskProb').textContent;
                const statusStatus = document.getElementById('statusStatus').textContent;
                const statusProb = document.getElementById('statusProb').textContent;

                // Extract percentages
                const riskMatch = riskProb.match(/(\d+\.?\d*)%/);
                const statusMatch = statusProb.match(/(\d+\.?\d*)%/);

                const riskProbValue = riskMatch ? parseFloat(riskMatch[1]) : 0;
                const statusProbValue = statusMatch ? parseFloat(statusMatch[1]) : 0;

                // Reconstruct results
                const results = {
                    diabetes_risk: {
                        prediction: riskStatus.includes('HIGH') ? 1 : 0,
                        probability: {
                            low_risk: 100 - riskProbValue,
                            high_risk: riskProbValue
                        }
                    },
                    current_status: {
                        prediction: statusStatus.includes('CONCERNING') ? 1 : 0,
                        probability: {
                            normal: 100 - statusProbValue,
                            concerning: statusProbValue
                        }
                    }
                };

                window.currentTestData = {
                    formData: formData,
                    results: results
                };

                console.log('‚úÖ Data reconstructed from page');
            }

            // Check if jsPDF is loaded
            if (typeof window.jspdf === 'undefined') {
                console.error('‚ùå jsPDF library not loaded');
                alert('PDF library not loaded. Please refresh the page and try again.');
                return;
            }

            console.log('‚úÖ All checks passed! Generating PDF...');

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                const data = window.currentTestData.formData;
                const results = window.currentTestData.results;

            // Page styling
            const primaryColor = [102, 126, 234];
            const accentColor = [118, 75, 162];
            const successColor = [81, 207, 102];
            const warningColor = [255, 107, 107];

            let yPos = 20;

            // Header with gradient effect
            doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
            doc.rect(0, 0, 210, 45, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(28);
            doc.setFont('helvetica', 'bold');
            doc.text('Diabetes Health Assessment', 105, 20, { align: 'center' });

            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text('AI-Powered Risk Analysis Report', 105, 30, { align: 'center' });

            // Report ID and date
            doc.setFontSize(9);
            const reportId = 'REPORT-' + Date.now();
            doc.text('Report ID: ' + reportId, 105, 38, { align: 'center' });

            yPos = 55;

            // Patient Information Section
            doc.setFillColor(245, 245, 250);
            doc.rect(10, yPos - 5, 190, 45, 'F');

            doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('Patient Information', 15, yPos);

            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');

            yPos += 8;
            doc.text('Name: ' + data.patient_name, 15, yPos);
            yPos += 6;

            const testDateTime = new Date(data.test_date);
            const formattedDate = testDateTime.toLocaleDateString('en-US', {
                year: 'numeric', month: 'long', day: 'numeric'
            });
            const formattedTime = testDateTime.toLocaleTimeString('en-US', {
                hour: '2-digit', minute: '2-digit'
            });
            doc.text('Test Date: ' + formattedDate, 15, yPos);
            yPos += 6;
            doc.text('Test Time: ' + formattedTime, 15, yPos);
            yPos += 6;

            if (data.patient_email) {
                doc.text('Email: ' + data.patient_email, 15, yPos);
                yPos += 6;
            }
            if (data.patient_phone) {
                doc.text('Phone: ' + data.patient_phone, 15, yPos);
                yPos += 6;
            }

            const genderMap = { 'male': 'Male', 'female': 'Female', 'other': 'Other' };
            doc.text('Age: ' + data.age + ' years  |  Gender: ' + genderMap[data.gender], 15, yPos);

            yPos += 15;

            // Assessment Results Section
            doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
            doc.rect(10, yPos - 5, 190, 10, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('Assessment Results', 15, yPos);

            yPos += 15;

            // Long-term Diabetes Risk
            const riskPrediction = results.diabetes_risk.prediction;
            const riskProb = results.diabetes_risk.probability.high_risk;

            doc.setFillColor(riskPrediction === 1 ? warningColor[0] : successColor[0],
                           riskPrediction === 1 ? warningColor[1] : successColor[1],
                           riskPrediction === 1 ? warningColor[2] : successColor[2]);
            doc.roundedRect(10, yPos - 5, 90, 35, 3, 3, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('Long-term Diabetes Risk', 15, yPos);

            doc.setFontSize(20);
            doc.text(riskPrediction === 1 ? 'HIGH RISK' : 'LOW RISK', 15, yPos + 10);

            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.text('Risk Level: ' + riskProb.toFixed(1) + '%', 15, yPos + 20);

            // Current Blood Sugar Status
            const statusPrediction = results.current_status.prediction;
            const statusProb = results.current_status.probability.concerning;

            doc.setFillColor(statusPrediction === 1 ? warningColor[0] : successColor[0],
                           statusPrediction === 1 ? warningColor[1] : successColor[1],
                           statusPrediction === 1 ? warningColor[2] : successColor[2]);
            doc.roundedRect(110, yPos - 5, 90, 35, 3, 3, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('Current Blood Sugar Status', 115, yPos);

            doc.setFontSize(20);
            doc.text(statusPrediction === 1 ? 'CONCERNING' : 'NORMAL', 115, yPos + 10);

            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.text('Alert Level: ' + statusProb.toFixed(1) + '%', 115, yPos + 20);

            yPos += 45;

            // Recommendations Section
            doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('Recommendations', 15, yPos);

            yPos += 10;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');

            // Risk Recommendation
            doc.setFont('helvetica', 'bold');
            doc.text(riskPrediction === 1 ? 'Long-term Risk Assessment:' : 'Long-term Risk Assessment:', 15, yPos);
            yPos += 6;
            doc.setFont('helvetica', 'normal');

            if (riskPrediction === 1) {
                const riskText = 'Your lifestyle and symptoms indicate elevated diabetes risk. Please consult with a healthcare provider for proper screening (HbA1c test, fasting glucose). Consider lifestyle modifications: increase physical activity, improve diet, and maintain healthy weight.';
                const lines = doc.splitTextToSize(riskText, 180);
                doc.text(lines, 15, yPos);
                yPos += lines.length * 6 + 8;
            } else {
                const riskText = 'Your current risk factors are low. Maintain your healthy lifestyle with regular exercise, balanced diet, and routine check-ups.';
                const lines = doc.splitTextToSize(riskText, 180);
                doc.text(lines, 15, yPos);
                yPos += lines.length * 6 + 8;
            }

            // Status Recommendation
            doc.setFont('helvetica', 'bold');
            doc.text(statusPrediction === 1 ? 'Current Status Assessment:' : 'Current Status Assessment:', 15, yPos);
            yPos += 6;
            doc.setFont('helvetica', 'normal');

            if (statusPrediction === 1) {
                const statusText = 'Your current symptoms suggest possible blood sugar issues. If you have diabetes, check your glucose levels now. If symptoms worsen (severe confusion, loss of consciousness), seek immediate medical attention.';
                const lines = doc.splitTextToSize(statusText, 180);
                doc.text(lines, 15, yPos);
                yPos += lines.length * 6 + 8;
            } else {
                const statusText = 'Your current symptoms do not indicate immediate blood sugar concerns. Continue monitoring your health and maintain regular meal patterns.';
                const lines = doc.splitTextToSize(statusText, 180);
                doc.text(lines, 15, yPos);
                yPos += lines.length * 6 + 8;
            }

            // Health Data Summary (if space available)
            if (yPos < 215) {
                doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('Health Data Summary', 15, yPos);

                yPos += 8;
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');

                const bmiLabels = ['Underweight', 'Normal', 'Overweight', 'Obese'];
                const activityLabels = ['None', 'Light', 'Moderate', 'High'];
                const dietLabels = ['Poor', 'Average', 'Good'];

                doc.text('BMI Category: ' + bmiLabels[data.bmi_category], 15, yPos);
                doc.text('Physical Activity: ' + activityLabels[data.physical_activity], 110, yPos);
                yPos += 6;
                doc.text('Diet Quality: ' + dietLabels[data.diet_quality], 15, yPos);
                doc.text('Family History: ' + (data.family_history == 1 ? 'Yes' : 'No'), 110, yPos);
            }

            // Footer
            doc.setFillColor(245, 245, 250);
            doc.rect(0, 270, 210, 27, 'F');

            doc.setTextColor(100, 100, 100);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.text('Medical Disclaimer:', 105, 278, { align: 'center' });

            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            const disclaimer1 = 'This is an AI screening tool for educational purposes, not a medical diagnosis.';
            const disclaimer2 = 'Always consult healthcare professionals for proper diagnosis and treatment.';
            doc.text(disclaimer1, 105, 283, { align: 'center' });
            doc.text(disclaimer2, 105, 288, { align: 'center' });

            doc.setTextColor(120, 120, 120);
            doc.setFontSize(7);
            const generatedText = 'Generated on: ' + new Date().toLocaleString();
            doc.text(generatedText, 105, 293, { align: 'center' });

            // Save the PDF
            const fileName = 'Diabetes_Report_' + data.patient_name.replace(/\s+/g, '_') + '_' + new Date().toISOString().split('T')[0] + '.pdf';
            doc.save(fileName);

            console.log('‚úÖ PDF exported successfully:', fileName);
            alert('Report exported successfully as ' + fileName);

            } catch (error) {
                console.error('‚ùå Error generating PDF:', error);
                alert('Error generating PDF: ' + error.message + '. Please check the console for details.');
            }
        }
    </script>
</body>
</html>